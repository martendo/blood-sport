/*
 * Blood Sport (https://github.com/martendo7/blood-sport)
 * Copyright (C) 2021 Martin Baldwin
 * Licensed under the GNU General Public License v3.0
 */
"use strict";(()=>{const t={t:"NOT_RUNNING",s:"TITLE_SCREEN",i:"IN_GAME",h:"END_SCREEN"},s={o:"#ff00ff"};class i{constructor(t=null,s=null,h=null,e=null){t instanceof i&&null==s&&null==h&&null==e?(this.l=t.l,this.u=t.u,this.g=t.g,this.p=t.p):(this.l=t||0,this.u=s||0,this.g=h||0,this.p=e||0)}get x(){return this.l}set x(t){this.l=t}get left(){return this.l}set left(t){this.l=t}get right(){return this.l+this.g}set right(t){this.l=t-this.g}get m(){return this.l+this.g/2}set m(t){this.l=t-this.g/2}get y(){return this.u}set y(t){this.u=t}get top(){return this.u}set top(t){this.u=t}get bottom(){return this.u+this.p}set bottom(t){this.u=t-this.p}get A(){return this.u+this.p/2}set A(t){this.u=t-this.p/2}get width(){return this.g}set width(t){this.g=t}get height(){return this.p}set height(t){this.p=t}S(t){return this.left<t.right&&this.right>t.left&&this.top<t.bottom&&this.bottom>t.top}}class h{constructor(t=null,s=null){t instanceof h&&null==s?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=s||0)}}class e{constructor(t,s,i){this.T=t,this.k=s,this.v=i;const h=this.T.R;this.M=[];for(const t of this.v.images)this.M.push(h[t]);this.duration=this.v.duration,this.frame=0,this.timeout=null,this.B=!1}get N(){return this.M[this.frame]}next(){this.frame=(this.frame+1)%this.M.length,this.T.C=this.N,this.j()}j(){this.timeout=setTimeout(()=>this.next(),this.duration[this.frame])}start(){null==this.timeout&&this.j(),this.B=!0,this.T.C=this.N}stop(){null!=this.timeout&&clearTimeout(this.timeout),this.timeout=null,this.B=!1}}class n{constructor(t){this.k=t,this.G=new Set,this.direction=this.k.L}D(t){const s=new i(this.rect);s.x-=this.k.map.O.I.x,s.y-=this.k.map.O.I.y,t.drawImage(this.C,s.x,s.y,s.width,s.height)}P(t){for(const s of Object.values(this.U))s!==t&&s.stop();t.start()}_(){for(const t of this.G)t.remove(this);this.hasOwnProperty("animation")&&this.animation.stop()}}class o{constructor(){this.W=new Set}add(t){this.W.add(t),t.G.add(this)}remove(t){this.W.delete(t),t.G.delete(this)}empty(){for(const t of this.W)this.remove(t)}*[Symbol.iterator](){for(const t of this.W)yield t}D(t){for(const s of this.W)s.D(t)}get count(){return this.W.size}}class a extends n{constructor(t){super(t),this.enabled=!0,this.q=!1,this.I=new h,this.F=new h,this.H=new i,this.Y={x:!1,y:!1},this.k.K.add(this)}X(t){this.rect=t,this.rect.left=Math.floor(this.I.x),this.rect.bottom=Math.floor(this.I.y)}update(){let t;this.I.x+=this.F.x,this.I.y+=this.F.y,this.Y.x=!1,this.Y.y=!1,this.rect.left=Math.floor(this.I.x),null!=(t=this.J())&&(this.F.x>0?this.I.x=t.rect.left-this.H.right:this.F.x<0&&(this.I.x=t.rect.right-this.H.left),this.V());const s=this.k.map.width*this.k.Z;this.I.x+this.H.left<0?(this.I.x=0-this.H.x,this.V()):this.I.x+this.H.right>s&&(this.I.x=s-this.H.right,this.V()),this.rect.bottom=Math.floor(this.I.y),null!=(t=this.J())&&(this.F.y>0?this.I.y=t.rect.top+(this.rect.height-this.H.bottom):this.F.y<0&&(this.I.y=t.rect.bottom+(this.rect.height-this.H.top)),this.tt());const i=this.k.map.height*this.k.Z;this.rect.top+this.H.top<0?(this.I.y=0-this.H.top+this.rect.height,this.tt()):this.rect.top+this.H.bottom>i&&(this.I.y=i-this.rect.height+this.H.bottom,this.tt());for(const t of this.k.K)this.st(this,t)&&this.it(t);Math.floor(this.rect.top/this.k.Z)>this.k.map.height&&this.ht()}et(t){return new i(t.rect.x+t.H.x,t.rect.y+t.H.y,t.H.width,t.H.height)}J(){const t=this.et(this);for(let s=t.top;s<t.bottom;s++)for(let i=t.left;i<t.right;i++){const t=Math.floor(i/this.k.Z),h=Math.floor(s/this.k.Z),e=this.k.map.nt(t,h);if(e.ot)return e}return null}V(){this.Y.x=!0,this.F.x=0,this.rect.left=Math.floor(this.I.x)}tt(){this.Y.y=!0,this.F.y=0,this.rect.bottom=Math.floor(this.I.y)}st(t,s){if(t===s)return!1;const i=this.et(t),h=this.et(s);return i.S(h)}ht(){this._(),this.q=!0}it(t){}}class r extends a{constructor(t){super(t),this.R=this.k.at.goddard,this.rt=.25,this.ct=.125,this.lt=1.5,this.ut=240,this.U={dt:new e(this,this.k,{images:[0,1],duration:[100,100]}),wt:new e(this,this.k,{images:[2,3],duration:[100,100]}),ft:new e(this,this.k,{images:[4,5],duration:[100,100]}),gt:new e(this,this.k,{images:[6,7],duration:[100,100]}),pt:new e(this,this.k,{images:[8,9],duration:[50,50]}),xt:new e(this,this.k,{images:[10,11],duration:[50,50]}),yt:new e(this,this.k,{images:[12,13],duration:[50,50]}),At:new e(this,this.k,{images:[14,15],duration:[50,50]})},this.C=this.U.gt.N,this.X(new i(0,0,this.C.width,this.C.height)),this.H=new i(3,16,10,16),this.reset(void 0,this.k.L)}update(){let t;this.k.Et.bt.has("Spacebar")&&this.attack(),this.k.Et.keys.has("ArrowLeft")&&(this.F.x-=this.rt),this.k.Et.keys.has("ArrowRight")&&(this.F.x+=this.rt),this.k.Et.keys.has("ArrowUp")&&(this.F.y-=this.rt),this.k.Et.keys.has("ArrowDown")&&(this.F.y+=this.rt),this.F.x>0?(this.F.x-=this.ct,this.F.x<0&&(this.F.x=0)):this.F.x<0&&(this.F.x+=this.ct,this.F.x>0&&(this.F.x=0)),this.F.y>0?(this.F.y-=this.ct,this.F.y<0&&(this.F.y=0)):this.F.y<0&&(this.F.y+=this.ct,this.F.y>0&&(this.F.y=0)),this.F.x>this.lt?this.F.x=this.lt:this.F.x<-this.lt&&(this.F.x=-this.lt),this.F.y>this.lt?this.F.y=this.lt:this.F.y<-this.lt&&(this.F.y=-this.lt),super.update(),this.F.y<0?this.direction=this.k.St:this.F.y>0?this.direction=this.k.Tt:this.F.x<0?this.direction=this.k.kt:this.F.x>0&&(this.direction=this.k.L),null!=this.weapon&&this.weapon.update(),this.F.y<0?t=this.U.pt:this.F.y>0?t=this.U.xt:this.F.x<0?t=this.U.yt:this.F.x>0?t=this.U.At:this.direction===this.k.St?t=this.U.dt:this.direction===this.k.Tt?t=this.U.wt:this.direction===this.k.kt?t=this.U.ft:this.direction===this.k.L&&(t=this.U.gt),this.P(t),this.C=t.N}attack(){null!=this.weapon&&(this.weapon.ht(),clearTimeout(this.weapon.timeout)),this.weapon=new u(this.k,this),this.vt=!0,this.weapon.timeout=setTimeout(()=>{this.weapon.ht(),this.weapon=null,this.vt=!1},this.ut)}reset(t=new h,s=null){this.I=new h(t),null!=s&&(this.direction=s),this.Rt=0,this.weapon=null,this.vt=!1;for(const t of Object.values(this.U))t.stop();this.U.gt.start(),this.C=this.U.gt.N}}class c extends a{constructor(t){super(t),this.Mt=60*this.k.Bt}it(t){t instanceof r&&t.vt||t instanceof u?this.ht():this.Nt()}update(){super.update(),this.rect.S(new i(this.k.map.O.I.x,this.k.map.O.I.y,this.k.canvas.width,this.k.canvas.height))||0!=Math.floor(Math.random()*this.Mt)||(this._(),this.k.Ct++)}Nt(){}ht(){this._(),this.q||(this.k.jt.Rt++,this.q=!0)}}const l={"subject-a":class extends c{constructor(t,s){super(t),this.R=this.k.at["targets/subject-a"],this.Gt=.25,this.I=s,this.animation=new e(this,this.k,{images:[0,1],duration:[250,250]}),this.C=this.animation.N,this.X(new i(0,0,this.C.width,this.C.height)),this.H=new i(3,16,10,16),this.animation.start(),this.direction=Math.floor(4*Math.random()),this.Lt()}Lt(){this.direction===this.k.St?(this.F.x=0,this.F.y=-this.Gt):this.direction===this.k.Tt?(this.F.x=0,this.F.y=this.Gt):this.direction===this.k.kt?(this.F.x=-this.Gt,this.F.y=0):this.direction===this.k.L&&(this.F.x=this.Gt,this.F.y=0)}Dt(){this.direction^=1,this.Lt()}update(){super.update(),(this.Y.x||this.Y.y)&&this.Dt()}Nt(){this.Dt()}},"subject-b":class extends c{constructor(t,s){super(t),this.R=this.k.at["targets/subject-b"],this.I=s,this.animation=new e(this,this.k,{images:[0,1],duration:[500,500]}),this.C=this.animation.N,this.X(new i(0,0,this.C.width,this.C.height)),this.H=new i(2,6,11,10),this.animation.start()}},"subject-c":class extends c{constructor(t,s){super(t),this.R=this.k.at["targets/subject-c"],this.I=s,this.animation=new e(this,this.k,{images:[0,1,0,1],duration:[1500,100,100,100]}),this.C=this.animation.N,this.X(new i(0,0,this.C.width,this.C.height)),this.H=new i(3,16,10,16),this.animation.start()}}};class u extends n{constructor(t,s){super(t),this.R=this.k.at.weapon,this.parent=s,this.I=new h,this.animation=new e(this,this.k,{images:[0,1,2,3,4,5,6,7],duration:[30,30,30,30,30,30,30]}),this.C=this.animation.N,this.rect=new i(0,0,this.C.width,this.C.height),this.H=new i(2,2,60,60),this.parent.F.y<0?this.parent.F.x<0?this.animation.frame=7:this.parent.F.x>0?this.animation.frame=1:this.animation.frame=0:this.parent.F.y>0?this.parent.F.x<0?this.animation.frame=5:this.parent.F.x>0?this.animation.frame=3:this.animation.frame=4:this.parent.F.x<0?this.animation.frame=6:this.parent.F.x>0?this.animation.frame=2:this.animation.frame=0,this.animation.start(),this.k.K.add(this)}update(){this.rect.m=this.parent.rect.m,this.rect.A=this.parent.rect.A,this.I.x=this.rect.left,this.I.y=this.rect.bottom}ht(){this._()}}class d extends n{constructor(t,s,h,e,n,o){super(t),this.It={1:24,2:3},this.map=s,this.Ot=n,this.ot=this.Ot>=this.It[this.map.Pt],this.C=this.k.Ut[this.map.Pt][this.Ot],this._t=o,this.x=h,this.y=e,this.rect=new i(this.x*this.k.Z,this.y*this.k.Z,this.k.Z,this.k.Z)}}class w{constructor(t){this.k=t,this.I=new h(0,0)}update(t){const s=this.k.map.width*this.k.Z;if(s<=this.k.canvas.width)this.I.x=-(this.k.canvas.width/2-s/2);else{const i=t.m-this.k.canvas.width/2;i<0?this.I.x=0:i+this.k.canvas.width>=s?this.I.x=s-this.k.canvas.width:this.I.x=i}const i=this.k.map.height*this.k.Z;if(i<=this.k.canvas.height)this.I.y=-(this.k.canvas.height/2-i/2);else{const s=t.A-this.k.canvas.height/2;s<0?this.I.y=0:s+this.k.canvas.height>=i?this.I.y=i-this.k.canvas.height:this.I.y=s}}}class f{constructor(t,s,i,h){this.k=t,this.enabled=!1,this.rect=s,this.text=i,this.Wt=h,this.k.buttons.add(this)}$t(){const t=this.k.Et.qt.I;return t.x>=this.rect.x&&t.x<this.rect.x+this.rect.width&&t.y>=this.rect.y&&t.y<this.rect.y+this.rect.height}click(){this.Wt()}D(t){t.fillStyle="#000000",t.globalAlpha=this.$t()?.25:.125,t.fillRect(this.rect.x,this.rect.y,this.rect.width,this.rect.height),t.globalAlpha=1,this.k.Ft({Ht:t,text:this.text,x:this.rect.x+this.rect.width/2,y:this.rect.y+this.rect.height/2,font:"50px sans-serif",textAlign:"center",textBaseline:"middle"})}}new class{constructor(){this.zt=document.title,this.Yt=15,this.Bt=60,this.Kt=1e3/this.Bt,this.Qt=4*this.Bt,this.Xt=4,this.St=0,this.Tt=1,this.kt=2,this.L=3,this.Jt=4,this.Z=8,this.Vt=2,this.Zt=!1,this.state=t.t,this.delta=0,this.ts=0,this.Et=new class{constructor(t){this.k=t,this.keys=new Set,this.ss=new Set,this.bt=new Set,window.addEventListener("keydown",t=>this.hs(t)),window.addEventListener("keyup",t=>this.hs(t)),this.qt={I:new h,pressed:!1,es:!1},window.addEventListener("pointerdown",t=>this.ns(t)),window.addEventListener("pointerup",t=>this.ns(t)),window.addEventListener("pointermove",t=>this.ns(t))}hs(t){let s;switch(t.key.toUpperCase()){case"LEFT":case"ARROWLEFT":case"A":s="ArrowLeft";break;case"RIGHT":case"ARROWRIGHT":case"D":s="ArrowRight";break;case"UP":case"ARROWUP":case"W":s="ArrowUp";break;case"DOWN":case"ARROWDOWN":case"S":s="ArrowDown";break;case"SPACEBAR":case" ":s="Spacebar";break;default:return}t.preventDefault(),"keydown"===t.type?this.keys.add(s):"keyup"===t.type&&this.keys.delete(s)}ns(t){"pointermove"!==t.type&&0!==t.button||(this.qt.I=new h(t.clientX,t.clientY),"pointermove"!==t.type&&(this.qt.es="pointerdown"===t.type,this.qt.pressed=this.qt.es))}update(){this.bt=new Set(this.keys);for(let t of this.ss)this.bt.delete(t);this.ss=new Set(this.keys),this.qt.es=!1}}(this),this.os=document.getElementById("displayCanvas"),this.as=this.os.getContext("2d"),window.addEventListener("resize",()=>this.rs()),this.canvas=document.getElementById("canvas"),this.Ht=this.canvas.getContext("2d"),this.rs(),this.cs()}async ls(){this.Ut={},await this.us(1,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABABAMAAABYR2ztAAAAG1BMVEVIfJgwMDBhYWGXl5eMYgyvfBXSnjWXvPrB1PKSk2TRAAAAAXRSTlMAQObYZgAAAJBJREFUSMftk+ENwBAQRq3Q2IAJsIIVdINaod2gHbtBcWkO/0QbLxLCixw+5AIQjHNPHLiQN5jCFMYQWqFtxn4BGIBb8z1VCfEWVms3Qjl7kMLYBBBkFHhBYIkhhXAPgxfZ4ZjatR5CJTBBqEQuCJXQeqEWe1ik8BM6/pY8IioIqijEEv8joHxCgI+FAp8b4wZjOl9JzG29KwAAAABJRU5ErkJggg=="),await this.us(2,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAwBAMAAAD5pqeQAAAAElBMVEVjb2xFLg5VQypmRBV7VyaIWyQjp6DsAAAAAXRSTlMAQObYZgAAAEZJREFUKM9jMA01NmaAAdNQ01AiOMbGRClD4QgiATSOCxwAOU5KUKAy3Dko3sYdOk5Q9eBAROa4QDguYA7M4IHjoDgHp6sBcV0/ma5v6h0AAAAASUVORK5CYII=")}async us(t,s){const i=await this.ds(s),h=[],e=Math.floor(i.width/this.Z),n=Math.floor(i.height/this.Z);for(let t=0;t<n;t++)for(let s=0;s<e;s++){const e=document.createElement("canvas");e.width=this.Z,e.height=this.Z,e.getContext("2d").drawImage(i,s*this.Z,t*this.Z,this.Z,this.Z,0,0,e.width,e.height),h.push(e)}this.Ut[t]=h}async ws(){this.at={},await this.fs("goddard","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABABAMAAAAg+GJMAAAAD1BMVEXHAQAAAAALL5cSQMkqWOC/Coj1AAAAAXRSTlMAQObYZgAAA3tJREFUWMPVV1uioyAMRVYgzgYwdAMDrKDuf09DHkAAr+3nnX70GDQhBsI5GvMLfhbAP6GZsIwbjQZSgkcME6Y4oAnpig9Y/LJGEy72rGjxwmsE0IiZaLSBM6tobCo/rzA6FxSaI11JoU05naYjOmYJkO8CbEe5odBeKZ17R0qlpkZ4OncoLDPzKxz9udN05GJoREeNNvN4xVJcr9HgzAM6N+CnZV5v/P0zYKDadrQyUcVycfknnFOeXwkj+Sf8IoN2A+7sl9ivPv7WqGsQ7+yPGXzohYK4f3DdMweQ5ba89Sny+wGtzGyTymAYeEkqL7kx2fU5HWAYqFsYZ0z+xs7SfVkClNpcEqBicxy6stm83oiysbg7QXDpxhUlQF+VpDKktqxteotJiimItUle4XKgLHhJBrVrObOGeKM+iC+52GF9BV1kLGq6gB/AnTPbtKE4IzJtqOdC7rVI4og42/PytqK2TC5x/AEN5JSBZ8SiwkUJYpHbVqfy/oR4FnKgRDXBhM5u8sAVf0ZzSK4HEQFlLgEIMUMKRRhX2zgA2oMOCjX5sv8AHPMQInEksSYhrPZWDme82AjwV47r3fDFbsx/oQ/kB1UPzAMf9QE/V6oWvRkGcj3SHs9EcbTQTiRxxC0J/qM+aI6DHkBHUGfjkz6ojltVKNB7IO7f6ANxdJrFd+6B6L7QB9VxC23vsyNmsn+hD5RjO5Vr6vErfdCoTVatUVvg1Vo5cdYHbbmFjKtj6PogTrogjvpgfH4ZsD0Df2fLhH0nhhyHnWj7GQc3dsGRS5cBmI7tyf5IrvOxvRzjE5c2lm1sG/gOpK4LtI0EA4KScWWk3PQBXiBPRL/a+lXATIzk1UBII+sG1WQzoYzsPDssAYQrQyXZTq5R64MwdWWzpSZNM+VJCpEOAKaypguUTalAZ2XQ3Ng+OOL4ztomScOeuAyo9kbJQ+8Y+bmmD5TNNO2r3qP4oNRe0wGVC2cbHWknbMhqtAv4E6oksJs6AUy6QNnoSJHwm+dN24McX/LFwzqAeb/rAmWbwol0sR3Yv9hip+NmlgCSE0qXqgu0vbndAjbw5rANwwW+DFFPur1uxPeOmYb27treynQH0zR+uxZOLknt9N3KAUBeqtB30wfaxgCF4vGvxIxI7RggRNg5gAUhUbc3XXAq25GK2PCi5MCFL2NFZex46x9HmHXtghZTzAAAAABJRU5ErkJggg==",16,32),await this.fs("targets/subject-a","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAD1BMVEVldC0AAAAUJmh9GhrcwXTsGMinAAAAAXRSTlMAQObYZgAAAIJJREFUKM+90cENwjAMheGELMATDIDMAqkeAzSq95+J2mmQqXJDIpff+t4xKU0ecPVmYBTH0Jd8HFZfoNocVNXhtjR2uNNheynXvWWvGnABq0NvomKr3uYtJCsN7AjwNXAGo/2oAcpp6FcYPpB+ARF5xtohsRN4XCT2TwBk/8rRE7wB2I0pCuzveUgAAAAASUVORK5CYII=",16,32),await this.fs("targets/subject-b","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQBAMAAACFLmBqAAAAElBMVEVjb2wAAABoMhmGYz0dhHAnrKJWZ6jNAAAAAXRSTlMAQObYZgAAAHJJREFUGNNNjMEJxDAMBJfAFXCkASPjAoKSCnL6G47tv5XISYTsz6xnQAAWEczP/1LecQtR1TIH2XSVKaD6kCm4+N4iAtooJQMaySEioNojgqi7cZwPQg/7jxHEx28cPQnyx9aTPozWk1Ceyp70Y694eAFshCN1kkB6AwAAAABJRU5ErkJggg==",16,16),await this.fs("targets/subject-c","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAD1BMVEXmAQAAAAArKytpamruw5pu000tAAAAAXRSTlMAQObYZgAAAGJJREFUKM9jYCAGuLig0iwuLg7INAOLiCOqgIsLRC2MxhRgcRRxQKYxBTCsFRQ2FESmGUEMAQRNnoAgVEAQLiAIFRCkmgCLo6AgyFcwGlMApFYAmaaTAJOikAIyzaAEBAgaADnIG/L/fn/2AAAAAElFTkSuQmCC",16,32),await this.fs("weapon","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAABAAgMAAAAR0ScsAAAADFBMVEVlLWc+Pj6QkJDBwcGqDE3+AAAAAXRSTlMAQObYZgAAAdxJREFUaN7t2TFugzAUAFBjBTWCJQt7ZpDCEcoRMoTz1Hsv0TFyh6ydwhVyBKtT1BOgqI0rtYu//QkOzTeqwh8Rih/f9veHMDbFb/AJMAHEvQPSCYACxMgAmq0xxwHK+9Y/r/elN0DSZHvrC+BHGkDuC0hfaAAr4QlYEW2CdOsJ2FNV3TNysVR+990kGiS1Zetcem6pAMjTIgDeKLKq1woPQKLJCjHX7v4qnD1fkC0BxrRbYaLKydMnXfOBzG68tq88nOgysDt4AOotHSCvPaZgs6QDzLN+QLShbD+yqhcQV5SAaN0LcJOUDz4cubucNr0A5464PMlhHYp8bZ0HznoBC3tT1E9aa3l9FhKp9VdtL/vZ1b/zAzDGX1x+gJk5PgIYEHH5IbunyAYYKZZy507BoOohLkyiDQC+hKKmWdvUAkRrRh1WobIAWUUOsEo1BCCl9vYBDyt4mOV1AAA8riEAOW4JGruz6JyCRxUAUOjulq45BgDAphU0tVjTSdDYge4eAODs0C2CtgtQvgf5qAJe3YCmCZIAOA54ud2HGZ/lCgfwt0AAcyATkKhAAPNjjwkoRChAjgNkqPHZXKCAZTCAMRQ3AIKNEAZgnL8euGLjxvgAce8ANgEmwL+Nb74zg5ZdkWVrAAAAAElFTkSuQmCC",64,64)}async fs(t,s,i,h){const e=await this.ds(s),n=[];for(let t=0;t<Math.floor(e.height/h);t++)for(let s=0;s<Math.floor(e.width/i);s++){const o=document.createElement("canvas");o.width=i,o.height=h,o.getContext("2d").drawImage(e,s*i,t*h,i,h,0,0,o.width,o.height),n.push(o)}this.at[t]=n}async cs(){await this.ws(),await this.ls(),this.buttons=new Set,this.gs=new class{constructor(t){this.k=t,this.Yt=15,this.ps=300,this.xs=75,this.button=new f(this.k,{x:0,y:0,width:this.ps,height:this.xs},"Play",()=>this.ms())}show(){this.k.state=t.s,this.button.enabled=!0}ms(){this.button.enabled=!1,this.k.map.load(1)}D(t){t.fillStyle="#000000",this.k.Ft({Ht:t,text:this.k.zt,x:t.canvas.width/2,y:t.canvas.height/3,font:"75px sans-serif",textAlign:"center",textBaseline:"middle"}),this.k.Ft({Ht:t,text:'"They gleaned for sport—for the joy of it—…because they can" (Shusterman 263)',x:t.canvas.width/2,y:t.canvas.height/3+75,font:"18px sans-serif"}),this.k.Ft({Ht:t,text:"Copyright (C) 2021 Martin Baldwin",x:0+this.Yt,y:t.canvas.height-25-this.Yt,textAlign:"start",textBaseline:"bottom"}),this.k.Ft({Ht:t,text:"Licensed under the GNU General Public License v3.0",x:0+this.Yt,y:t.canvas.height-this.Yt}),this.k.Ft({Ht:t,text:"Last modified Jun 4, 2021",x:t.canvas.width-this.Yt,y:t.canvas.height-25-this.Yt,textAlign:"end"}),this.k.Ft({Ht:t,text:"https://github.com/martendo/blood-sport",x:t.canvas.width-this.Yt,y:t.canvas.height-this.Yt}),this.button.rect.x=t.canvas.width/2-this.ps/2,this.button.rect.y=t.canvas.height/2-this.xs/2,this.button.D(t)}}(this),this.ys=new class{constructor(t){this.k=t,this.As=2e3,this.ps=300,this.xs=75,this.button=new f(this.k,{x:0,y:0,width:this.ps,height:this.xs},"Continue",()=>this.bs()),this.Es=!1}show(){this.Es||(setTimeout(()=>this.k.state=t.h,this.As),this.Ss=Math.abs(this.k.jt.Rt/this.k.map.Ts-1)<=.2,this.ks=this.Ss&&this.k.map.Pt>=this.k.Vt,this.button.enabled=this.Ss,this.ks&&(this.button.enabled=!1),this.Es=!0)}bs(){this.button.enabled=!1,this.k.map.load(this.k.map.Pt+1),this.Es=!1}D(t){t.fillStyle="#000000",this.k.Ft({Ht:t,text:`Gleaned: ${this.k.jt.Rt}`,x:t.canvas.width/2,y:t.canvas.height/3,font:"50px sans-serif",textAlign:"center",textBaseline:"middle"}),this.k.Ft({Ht:t,text:`Escaped: ${this.k.Ct}`,x:t.canvas.width/2,y:t.canvas.height/3+60}),this.k.Ft({Ht:t,text:`Quota: ${this.k.map.Ts}`,x:t.canvas.width/2,y:t.canvas.height/3+150}),this.ks?this.k.Ft({Ht:t,text:"All mass gleanings have been completed.",x:t.canvas.width/2,y:t.canvas.height/3*2}):this.Ss?(this.button.rect.x=t.canvas.width/2-this.ps/2,this.button.rect.y=t.canvas.height/3*2-this.xs/2,this.button.D(t)):this.k.Ft({Ht:t,text:"You're too far off the quota! That is unacceptable!",x:t.canvas.width/2,y:t.canvas.height/3*2,font:"50px sans-serif",textAlign:"center",textBaseline:"middle"})}}(this),this.map=new class{constructor(t){this.vs=0,this.Rs=2147483648,this.Ms=1073741824,this.Bs=536870912,this.k=t,this.tilesets={},this.Pt=1,this.Ns=new d(this.k,this,0,0,0,{Cs:!1,js:!1,d:!1}),this.Pt=null,this.Gs=s.o,this.O=new w(this.k),this.Ls=new o,this.Ds=new o,this.Is={},this.Os=new h,this.Ps=this.k.L,this.Us=!1}_s(t){for(const s of this.data.layers)if(s.type===t)return s;throw`No layer of type "${t}" found in GameMap.data`}async load(s){this.Us=!1,this.k.state=t.i,this.Pt=s;const i=await fetch(`maps/${s}.json`,{headers:{"Cache-Control":"no-cache"}}),h=await i.json();this.cs(h)}cs(t){this.data=t,this.Gs=this.data.backgroundcolor,this.Ws=this._s("tilelayer").data,this.width=this.data.width,this.height=this.data.height,this.objects=this._s("objectgroup").objects,this.$s=[];for(const t of this.objects)if("startpoint"===t.type){this.Os=new h(t.x,t.y);for(const s of t.properties)if("flip"===s.name){this.Ps=s.value?this.k.kt:this.k.L;break}}else t.hasOwnProperty("gid")&&this.$s.push(t);for(const t of this.data.properties)if("quota"===t.name){this.Ts=t.value;break}this.reset()}qs(){this.Ls.empty(),this.Is={};for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++){const i=t*this.width+s,[h,e,n]=this.Fs(this.Ws[i]);if(h===this.vs)continue;const o=new d(this.k,this,s,t,h-e.firstgid,n);this.Ls.add(o),this.Is[i]=o}}async Hs(){for(const t of this.Ds)this.k.K.delete(t);this.Ds.empty();for(const t of this.$s){const[s,i,e]=this.Fs(t.gid),n=await this.zs(s-i.firstgid,`maps/${i.source}`);this.Ds.add(new l[n.type](this.k,new h(t.x,t.y)))}}Fs(t){const s={Cs:Boolean(t&this.Rs),js:Boolean(t&this.Ms),d:Boolean(t&this.Bs)};t&=~(this.Rs|this.Ms|this.Bs);for(let i=this.data.tilesets.length-1;i>=0;i--){const h=this.data.tilesets[i];if(h.firstgid<=t)return[t,h,s]}return[this.vs,null,s]}async Ys(t){if(this.tilesets.hasOwnProperty(t))return this.tilesets[t];const s=await fetch(t,{headers:{"Cache-Control":"no-cache"}}),i=await s.json();return this.tilesets[t]=i,i}async zs(t,s){const i=await this.Ys(s);for(const s of i.tiles)if(s.id==t)return s;return null}nt(t,s){if(t<0||s<0||t>=this.width||s>=this.height)return this.Ns;const i=s*this.width+t;return this.Is.hasOwnProperty(i)?this.Is[i]:this.Ns}update(){for(const t of this.Ds)t.update();this.O.update(this.k.jt.rect)}D(t){t.fillStyle=this.Gs,t.fillRect(-this.O.I.x,-this.O.I.y,this.width*this.k.Z,this.height*this.k.Z),this.Ls.D(t)}async reset(){await this.qs(),await this.Hs(),this.k.jt.reset(this.Os,this.Ps),this.k.Ct=0,this.Us=!0}}(this),this.K=new o,this.jt=new r(this),this.start()}ds(t){return new Promise((s,i)=>{const h=new Image;h.addEventListener("load",()=>s(h)),h.addEventListener("error",()=>i()),h.src=t})}Ft({Ht:t,text:s,x:i,y:h,font:e,textAlign:n,textBaseline:o}){null!=e&&(t.font=e),null!=n&&(t.textAlign=n),null!=o&&(t.textBaseline=o),t.fillText(s,i,h)}rs(){const t=document.documentElement.getBoundingClientRect();this.os.width=t.width,this.os.height=t.height,this.canvas.width=t.width/this.Xt,this.canvas.height=t.height/this.Xt,this.as.imageSmoothingEnabled=!1,this.Ht.imageSmoothingEnabled=!1}start(){this.Zt=!0,this.gs.show(),requestAnimationFrame(this.Ks.bind(this))}Qs(){this.delta=0}Ks(s){if(!this.Zt)return void(this.state=t.t);if(s<this.ts+this.Kt)return void requestAnimationFrame(this.Ks.bind(this));this.delta+=s-this.ts,this.ts=s,this.Xs();let i=0;for(;this.delta>=this.Kt;)if(this.update(this.Kt),this.delta-=this.Kt,i++>=this.Qt){this.Qs();break}this.D(),requestAnimationFrame(this.Ks.bind(this))}Xs(){if(this.Et.qt.es)for(const t of this.buttons)t.enabled&&t.$t()&&t.click()}update(s){switch(this.Et.update(),this.state){case t.i:if(!this.map.Us)break;this.map.update(),this.jt.update(),this.map.Ds.count<1&&this.ys.show()}}D(){switch(this.Ht.clearRect(0,0,this.canvas.width,this.canvas.height),this.as.clearRect(0,0,this.os.width,this.os.height),this.state){case t.s:this.gs.D(this.as);break;case t.h:this.ys.D(this.as);break;case t.i:if(!this.map.Us)break;this.map.D(this.Ht),this.K.D(this.Ht),this.as.drawImage(this.canvas,0,0,this.os.width,this.os.height),this.as.fillStyle="#ffffff",this.as.fillRect(this.os.width+2,-3,-250,75),this.as.strokeStyle="#000000",this.as.lineWidth=3,this.as.strokeRect(this.os.width+2,-3,-250,75),this.as.fillStyle="#000000",this.Ft({Ht:this.as,text:`Gleaned: ${this.jt.Rt}`,x:this.os.width-this.Yt,y:this.Yt,font:"40px sans-serif",textAlign:"end",textBaseline:"top"})}}}})();